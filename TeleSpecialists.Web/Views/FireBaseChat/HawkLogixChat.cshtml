@using TeleSpecialists.BLL.ViewModels;
@model FireBaseData
@{
    //Layout = null;
}
<style>
    .r-icon-stats i {
        width: 66px;
        height: 66px;
        padding: 20px;
        text-align: center;
        color: #fff;
        font-size: 24px;
        display: inline-block;
        border-radius: 100%;
        vertical-align: top;
    }

    .bg-danger {
        background-color: #808f97 !important;
    }

    .r-icon-stats .bodystate {
        padding-left: 20px;
        display: inline-block;
        vertical-align: middle;
    }

    .chat-list {
        height: 590px !important;
    }

        .chat-list .odd .chat-image {
            float: right !important;
        }

        .chat-list .odd .chat-body {
            float: right !important;
            margin-right: 12px;
            text-align: right;
            color: #fff;
        }

        .chat-list .odd .chat-text {
            background: #808f97;
        }

            .chat-list .odd .chat-text h4 {
                color: #fff;
            }

        .chat-list .odduser .chat-image {
            float: left !important;
        }

        .chat-list .odduser .chat-body {
            float: left !important;
            color: #fff;
        }

        .chat-list .odduser .chat-text {
            background: #249ebf;
        }

            .chat-list .odduser .chat-text h4 {
                color: #fff;
            }

    .centerAlignSeen {
        text-align: center;
        color: lightslategray
    }

    .img-circle {
        height: 30px;
        width: 30px;
        -webkit-border-radius: 10px;
    }
</style>

<link href="~/Content/Elite/css/style.css" rel="stylesheet" />
@*<script src="~/Content/Elite/js/jquery-1.10.2.min.js"></script>*@
<script src="~/Content/Elite/js/jquery.slimscroll.js"></script>
<script src="~/Content/Elite/js/chat.js"></script>


@*<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>*@

<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
<script>
    if (!firebase.apps.length) {
        const config = {
            apiKey: "AIzaSyDHC8RJ-uUoWIo3tYa9zzhVhvTxv5NuZF0",
            authDomain: "telecare-3724e.firebaseapp.com",
            databaseURL: "https://telecare-3724e.firebaseio.com",
            projectId: "telecare-3724e",
            storageBucket: "telecare-3724e.appspot.com",
            messagingSenderId: "922280291570",
            appId: "1:922280291570:web:6ce723cfaeeed0f7c8b46b",
            measurementId: "G-8TWCZJP852"
        };
        firebase.initializeApp(config);
        //firebase.analytics();
    }
</script>

<div class="row bg-title">
    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
        <strong class="page-title"> Chat Page</strong> @*<span class="text-primary"> (Hit F5 if you are done with Chat)</span>*@
    </div>
    <div class="col-lg-6 col-sm-6 col-md-6 col-xs-12">
        <a href="#" target="_blank" data-toggle="modal" data-target=".bs-example-modal-lg" class="btn pull-right m-l-20 btn-rounded btn-outline hidden-xs hidden-sm waves-effect waves-light">Create Group</a>
        <ol class="breadcrumb">
            <li> <div id="userInfo">  </div>  </li>
        </ol>
    </div>
</div>
<div class="chat-main-box">
    <div class="chat-left-aside">
        <div class="open-panel"><i class="ti-angle-right"></i></div>
        <div class="chat-left-inner" style="height:700px;">
            <div class="form-material">
                <input class="form-control p-20" type="text" placeholder="Search Contact" id="txtSearch">
            </div>
            <div style="max-height:650px;overflow-y:auto;">
                <ul class="chatonline style-none" id="binduser"></ul>
            </div>
        </div>
    </div>
    <div class="chat-right-aside">
        <div class="chat-main-header">
            <div style="margin-top:5px;margin-left:5px;">
                <h3 class="box-title">Chat Message</h3>
                <div id="person">
                </div>
            </div>
        </div>
        <div class="chat-box" style="height:610px">
            <ul class="chat-list" id="msgDetail"></ul>
        </div>
        <div class="row send-chat-box">
            <div class="col-sm-12">
                <textarea class="form-control" placeholder="Type your message" id="txtMsg" style="height:100px"></textarea>
                <div class="custom-send">
                    <a href="javacript:void(0)" class="cst-icon" data-toggle="tooltip" title="Insert Emojis"><i class="ti-face-smile"></i></a>
                    <a href="javacript:void(0)" id="file" class="cst-icon" data-toggle="tooltip" title="File Attachment"><i class="fa fa-paperclip"></i></a>
                    <button class="btn btn-success btn-rounded" type="button" id="SendMsg">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" style="float:left">Add Group Title</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <input class="form-control" id="txtGroupName" placeholder="Enter Group Title Here" />
                <div>
                    <br>
                    @Html.RadioButton("grpType", "Private", new { @class = "lbltype", @checked = "true" })
                    <strong>Private (Only allowed members can chat)</strong> <br>
                    @Html.RadioButton("grpType", "Public", new { @class = "lbltype" })
                    <strong>Public (Anyone can send msg )</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark waves-effect text-left" data-dismiss="modal" id="btnClose">Close</button>
                <button type="button" class="btn btn-dark waves-effect text-left" id="saveGroup">Save</button>
            </div>
        </div>

    </div>

</div>
<div class="modal fade bs-example-modal-lg1" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myLargeModalLabel">Users List</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div style="max-height:300px;overflow-y:auto">
                    <ul class="chatonline style-none" id="userlistforGrp" style="list-style-type: none;"></ul>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark waves-effect text-left" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>

</div>
<script>
    $("#btnClose").click(function () {
        $('body').css('padding-right', '0');
    });
</script>

<script>
    var SenderId;
    var _senderName;
    var _senderPhoto;
    var _receiverId;
    var _receiverName;
    var _receiverPhoto;
    var _teleid;
    var _serverTime;
    var teleUsersArr = [];
    var isGroup;
    var teleUsersForGrpArr = [];
    var groupUsers = [];
    var _userType;
    var _GroupType;
    var _isOnline;
    var _allGroup = [];
    var _userChatList = [];
    var unreadMsg = [];
    var unreadMessage = 0;
    var totalNotifications = 0;
    var _msgType;
    var publicGrpArr = [];





    var FileExtensions = ['png', 'jpg', 'jpeg', 'gif', 'bmp',
        'txt', 'text',
        'doc', 'docx', 'docs', 'docm', 'dotx', 'dotm', 'docb',
        'pdf',
        'xlsx', 'xlx', 'xlsb', 'xlsm',
        'ppt', 'pptm', 'pptx',
        'mp4', 'wmv'];

    $(document).ready(function () {
        initApp();
    });
</script>
<script>
    //const config = {
    //    apiKey: "AIzaSyDHC8RJ-uUoWIo3tYa9zzhVhvTxv5NuZF0",
    //    authDomain: "telecare-3724e.firebaseapp.com",
    //    databaseURL: "https://telecare-3724e.firebaseio.com",
    //    projectId: "telecare-3724e",
    //    storageBucket: "telecare-3724e.appspot.com",
    //    messagingSenderId: "922280291570",
    //    appId: "1:922280291570:web:6ce723cfaeeed0f7c8b46b",
    //    measurementId: "G-8TWCZJP852"
    //};
     //firebase.initializeApp(config);

    var _ab;
    /// ************* Get Data From Group user ******* >>>>>>>>>>>>.
    //var refuser = firebase.database().ref("Group-users");
    //refuser.on("child_added", function (snapshot) {
    //    groupUsers.push({ id: snapshot.key });
    //});

    ////////////////////<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>////////////



    //firebase.database().ref('myUser').set({});



    function PassValues(myArr) {

        // var ref = firebase.database().ref("TeleUsers");
        //ref.orderByChild("teleid").equalTo('7').on("child_added", function (snapshot) {
        //    var liTag = "<li><a href = 'javascript:void(0)' > <img src='../plugins/images/users/varun.jpg' alt='user-img' class='img-circle'> <span> " + snapshot.val().name + "<small class='text-success'>online</small></span></a></li >";
        //    $("#binduser").append(liTag);
        //    console.log(snapshot.val().name);
        //});




        for (var i = 0; i < myArr.length; i++) {
            var id = myArr[i]._id;
            var teleid = myArr[i]._teleid;
            var email = myArr[i]._email;
            var password = myArr[i]._password;
            var name = myArr[i]._name;

            //firebase.database().ref('hawkuser').child(id).update({
            //    id: id,
            //    name: name,
            //    teleid: teleid
            //});



            //var currentUser = firebase.auth();
            //var userRef = firebase.database().ref("Users/Drivers").child(currentUser.uid);
            //userRef.on("value").then(function (snapshot) {
            //    console.log(snapshot.val());
            //})

            // var query = firebase.database().ref("TeleUsers/" + id ).update({ name: "New trainer 2" });//.child(id)//orderByChild(id).equalTo(name);
            //query.once("child_added", function (snapshot) {
            //    snapshot.ref.update({ name: "New trainer" })
            //});

            //var starCountRef = firebase.database().ref('TeleUsers/' + id + '/name');
            //starCountRef.on('value', function (snapshot) {
            //    updateStarCount(postElement, snapshot.val());
            //});

            //var refObj = firebase.database().ref('TeleUsers').child(id);
            //refObj.child('id').update({
            //    id: 101
            //});

            //firebase.database().ref('TeleUsers/' + id + '/' + 'Friends').set({
            //    userid: 355,
            //    LastMsg : 'yes'
            //});

            //firebase.database().ref('TeleUsers/' + id + '/' + 'Status').set({
            //    status: 'Active',
            //    date: '1/24/2019 05:15:45'
            //});
        }
    }


    function Save(name, email, teleid, img) {
        logout();
        var email = email; //'wistler@testschool.com';//'banas@testschool.com';//'richardson@testschool.com';// ;//'sophia1122@gmail.com';//  'raza123@gmail.com';//'steve1122@gmail.com';// 'robert@testschool.com';////'michael@testschool.com'; //'jack@testschool.com';//  //////  'principal@testschool.com';////'michael@testschool.com';//'smith@testschool.com';// //
        var username = name;//'Wistler George';//'Banas Williams';//'Richardson John';//'Sophia Isabella';// 'Raza Ahmad';//Steve  Morgan';//  'Robert Smith';//'Michael Smith';// 'Jack Jones';//  ////   'Muhammad Masud';//'jack@testschool.com';//'Michael Smith';//'Smith John';////-----------------------
        var tele_id = teleid; //7;
        var img = img;//'/Content/DownloadedFiles/default.png';

        loginUsername(email, email, tele_id, username, img);


    }

    function loginUsername(email, password, tele_id, username, img) {
        //debugger;
        firebase.auth().signInWithEmailAndPassword(email, password).then(function (value) {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    var userId = user.uid;
                    SenderId = userId;
                    _SignInStatus();
                    teleUsersArr = [];
                    teleUsersForGrpArr = [];
                    GetUsers(tele_id);
                    //***************************************** Test for On change purpose ******************************//

                    //******************************************************************************************************//
                    AfterChanged();
                    AfterModify();


                    //**************************************** temprary hide *****************************


                    //**************************************** temprary hide end *****************************
                    var ref = firebase.database().ref("TeleUsers");
                    ref.child(userId).once('value', function (snapshot) {
                        if (snapshot.val() !== null) {
                            $("#userInfo").html('');
                            _senderName = snapshot.val().name;
                            var src = snapshot.val().image;
                            //src += item_image;
                            var newImage = document.createElement('img');
                            newImage.src = src;
                            newImage.classList.add("img-circle");
                            _senderPhoto =  snapshot.val().image;
                            _teleid = snapshot.val().teleid;
                            $("#userInfo").append(newImage);
                            //var user_info = "<img src='" + _senderPhoto + "' class='img-circle' /> <span> " + _senderName + " </span>&nbsp;<span class='label label-rouded label-danger' id='lblnotify'></span>";
                            var user_info = " <span> " + _senderName + " </span>&nbsp;<span class='label label-rouded label-danger' id='lblnotify'></span>";
                            $("#userInfo").append(user_info);
                            $("#lblnotify").html(totalNotifications);
                            if (totalNotifications === 0)
                                $("#lblnotify1").html('');
                            else
                                $("#lblnotify1").html(totalNotifications);

                        }
                        else {
                           // alert('record not found');
                            firebase.database().ref('TeleUsers').child(userId).set({
                                id: userId,
                                name: username,
                                teleid: tele_id,
                                image: img
                            });
                            location.reload();
                        }

                    });

                    // LoadGroup();
                    //  LoadGroupNew();

                    GetAllGroups();
                }
                else {

                }
            });

        }).catch(function (error) {
            toast(error.message, 7000);
        });


    }

    function GetConnections() {
        var connectionList = firebase.database().ref("TeleUsers/" + SenderId + "/Connections");

        //_userChatList
    }

    function GetUsers(tele_id) {
        var ref = firebase.database().ref("TeleUsers");
        ref.orderByChild("teleid").equalTo(tele_id).on("child_added", function (snapshot) {
            if (SenderId !== snapshot.key) {
                var checkUserExist = teleUsersArr.some(x => x.id == snapshot.key);
                console.log('checkUserExist status is : ' + checkUserExist);
                if (!checkUserExist) {
                    teleUsersArr.push({ id: snapshot.key, name: snapshot.val().name, image: snapshot.val().image, searchname: snapshot.val().name.toLowerCase() });
                    teleUsersForGrpArr.push({ id: snapshot.key, name: snapshot.val().name, image: snapshot.val().image, searchname: snapshot.val().name.toLowerCase()});
                }
               // console.log('Snapshot record is: ' + snapshot.val().name);
            }
        });
    }

    function logout() {
        _SignOutStatus();
        firebase.auth().signOut().then(function () {

        }).catch(function (error) {
           // console.log("Error signing user out:", error);
        });
    }

    function OldCodeOfRetrievelist() {
        var getConnection = firebase.database().ref("TeleUsers/" + SenderId + "/Connections");
        getConnection.on('child_added', function (friends) {
            if (friends.key === snapshot.key) {
                if (friends.val().Online) {
                    onlineTag = "<span class='text-success'>online</span>";
                }
                else {
                    onlineTag = "<span class='text-muted'>offline</span>";
                }

                var liTag = "<li><a href = 'javascript:void(0)' id='btnRequest' data-senderid = '" + SenderId + "' data-receiverid = '" + snapshot.key + "' data-receiverName = '" + snapshot.val().name + "' data-receiverPhoto = '" + snapshot.val().image + "' data-onlineStatus = '" + friends.val().Online + "' data-isgrpPublic = 'false'> <img src='" + snapshot.val().image + "' alt='user-img' class='img-circle'> <span> " + snapshot.val().name + " <small class='text-success'>" + friends.val().lastMessage + " <span > " + onlineTag + " </span></small></span> </a> </li > ";
                //$("#binduser").append(liTag);
            }
        });

    }

    function LoadConnections() {
        // debugger;
        _userChatList.reverse();
        for (var i = 0; i < _userChatList.length; i++) {

            if (_userChatList[i].type === 'Private')
                var liTag = "<li><a href = 'javascript:void(0)' id='btnRequest' data-senderid = '" + _userChatList[i].senderid + "' data-type=" + _userChatList[i].type + " data-receiverid = '" + _userChatList[i].receiverid + "' data-receiverName = '" + _userChatList[i].receivername + "' data-receiverPhoto = '" + _userChatList[i].receiverphoto + "' data-onlineStatus = '" + _userChatList[i].onlinestatus + "' data-isgrpPublic = 'false'> <img src='" + _userChatList[i].receiverphoto + "' alt='user-img' class='img-circle'> <span> " + _userChatList[i].receivername + " <small class='text-success'>" + _userChatList[i].lastmsg + " <span > " + _userChatList[i].onlinetag + " </span></small></span> </a> </li > ";
            else
                var liTag = "<li><a href = 'javascript:void(0)' id='btnRequest' data-senderid = '" + _userChatList[i].senderid + "' data-type=" + _userChatList[i].type + " data-receiverid = '" + _userChatList[i].receiverid + "' data-receiverName = '" + _userChatList[i].receivername + "' data-receiverPhoto = '" + _userChatList[i].receiverphoto + "' data-onlineStatus = '" + _userChatList[i].onlinestatus + "' data-isgrpPublic = 'false'> <img src='" + _userChatList[i].receiverphoto + "' alt='user-img' class='img-circle'> <span> " + _userChatList[i].receivername + " <small class='text-success'>" + _userChatList[i].lastmsg + " (GROUP) <span ></span></small></span> </a> </li > ";

            // $("#binduser").append(liTag);
        }
    }

    $(document).on('click', "#btnRequest", function () {
        var _senderid = $(this).attr("data-senderid");
        var receiverid = $(this).attr("data-receiverid");
        var receiverName = $(this).attr("data-receiverName");
        var receiverPhoto = $(this).attr("data-receiverPhoto");
        var type = $(this).attr("data-type");
        var isGrpPublic = $(this).attr('data-isgrpPublic');
        if (isGrpPublic === 'true') { type = 'Public';}

        _isOnline = $(this).attr("data-onlineStatus");
        _msgType = type;
        // debugger;
        _receiverId = receiverid;
        _receiverName = receiverName;
        _receiverPhoto = receiverPhoto;
        //alert('sender : ' + _senderid + ', Receiver : ' + receiverid);
        // ReadMessageStatus(SenderId, receiverid);
        if (type)
            UpdateReadStatus(type);

        //************** Update Gruop Msg *********************//

        //*****************************************************//

        AfterModify();
        // debugger;
        GetPerson(type);
        var count = unreadMsg.length;
        if (type === 'Public') {
            isGroup = true;
            UpdateGroupChat(_receiverId);
            checkAllgrpUserReadMsg(_receiverId);
            //GetUnreadGrpMsg(_receiverId);
            _GetGroupChat(_senderid, receiverid);

        }
        else {
            isGroup = false;
            GetChatNew(_senderid, receiverid);

        }



        // CreateGroup();
        // AddUserToGroup();
        // GroupMessages();
        //UpdateGroup();
    });

    $(document).on('click', "#SendMsg", function () {
        // debugger;
        var msg = $("#txtMsg").val();
        var id = SenderId + '-' + _receiverId;
        var _id = _receiverId + '-' + SenderId;
        var shortMsg = msg.substring(0, 10) + '...';
        UserConnections(shortMsg);
        if (isGroup) {
            _GroupMessages(_receiverId, msg);
        }
        else {
            SendMessageNew(id, _id, msg, 'text');
        }

    });

    $(document).on('click', "#saveGroup", function () {
        var name = $("#txtGroupName").val();
        var grptype = $('input[name="grpType"]:checked').val();
        if (name) {
            CreateGroupNew(name, grptype);
            $("#txtGroupName").val('');
            $(".modal").hide();
        }
    });

    $("#txtMsg").keyup(function (event) {
        if (event.keyCode === 13) {
            var msg = $("#txtMsg").val();
            var id = SenderId + '-' + _receiverId;
            var _id = _receiverId + '-' + SenderId;
            var shortMsg = msg.substring(0, 10) + '...';

            UserConnections(shortMsg);

            console.log('is group : ' + isGroup);
            if (isGroup) {
                //GroupMessages(_receiverId, msg);
                //*********************** First Time read and update unread group msg of a user **********************//
                /*
                var grpUnread = GetUnreadGrpMsg(_receiverId);
                var ref = firebase.database().ref("TeleUsers/" + SenderId + '/Connections');
                ref.child(_receiverId).update({
                    lastOnline: firebase.database.ServerValue.TIMESTAMP,
                    name: _receiverName,
                    image: _receiverPhoto,
                    unread: grpUnread
                });
                */
                //***************************************************************************************************//
                _GroupMessages(_receiverId, msg, 'text');

            }
            else {
                SendMessageNew(id, _id, msg, 'text');
            }

        }
    });

    $("#txtSearch").keyup(function (event) {
        $("#binduser").html('');
        var txt = $("#txtSearch").val();
        if (txt) {
            var newArr = [];
            for (var i = 0; i < teleUsersArr.length; i++) {
                if (teleUsersArr[i].searchname.match(txt.toLowerCase())) {
                    newArr.push({ id: teleUsersArr[i].id, name: teleUsersArr[i].name, image: teleUsersArr[i].image, isGrpPublic : 'false' });
                }
            }
            for (var i = 0; i < publicGrpArr.length; i++) {
                if (publicGrpArr[i].searchgrpname.match(txt.toLowerCase())) {
                    newArr.push({ id: publicGrpArr[i].grpid, name: publicGrpArr[i].grpname, image: publicGrpArr[i].img, isGrpPublic: 'true' });
                }
            }
            for (var i = 0; i < _userChatList.length; i++) {
                if (_userChatList[i].searchname.match(txt.toLowerCase())) {
                    let found = newArr.some(x => x.id == _userChatList[i].id);
                    if (!found)
                        newArr.push({ id: _userChatList[i].id, name: _userChatList[i].name, image: _userChatList[i].image, isGrpPublic: 'false' });
                }
            }
            console.log(newArr);
            for (var i = 0; i < newArr.length; i++) {
                var liTag = "<li><a href = 'javascript:void(0)' id='btnRequest' data-senderid = '" + SenderId + "' data-receiverid = '" + newArr[i].id + "' data-receiverName = '" + newArr[i].name + "' data-receiverPhoto = '" + newArr[i].image + "'  data-isgrpPublic = '" + newArr[i].isGrpPublic + "'> <img src='" + newArr[i].image + "' alt='user-img' class='img-circle'> <span> " + newArr[i].name + "<small class='text-success'>online</small></span></a></li > ";
                $("#binduser").append(liTag);
            }
        }
        else {
            AfterModify();
        }
    });

    //$("#txtMsg").focus(function () {
    //   // alert('hi dost');
    //    UpdateReadStatus(_msgType);
    //});

    $(document).on('click', "#addUserToGrp", function () {
        $("#userlistforGrp").html('');
        //GetGroupUsers();
        _LoadGrpUsers();
    });

    function initApp() {
        //debugger;
        var name;
        var email;
        var teleid;
        var img;
        @{
            @:name = '@Model.name';
            @:email = '@Model.email';
            @:teleid = @Model.teleid;
            @:img = '@Model.ImgPath';
        }

        Save(name, email, teleid, img);

    }


</script>
<script>

    function AfterModify() {
        $("#binduser").html('');
        //  debugger;
        totalNotifications = 0;
        $("#binduser").empty();
        var getConnection = firebase.database().ref("TeleUsers/" + SenderId + "/Connections");
        getConnection.orderByChild('lastOnline').on('child_added', function (friends) {

            // create  friends list
            let isExist = _userChatList.some(x => x.id == friends.key);
            if (!isExist)
                _userChatList.push({ id: friends.key, name: friends.val().name, image: friends.val().image, searchname: friends.val().name.toLowerCase() });
            // end
            if (friends.val().Online) {
                onlineTag = "<span class='text-success'>online</span>";
            }
            else {
                onlineTag = "<span class='text-muted'>offline</span>";
            }
            //var _count = ReadMessageStatus(SenderId, friends.key);
            var date = new Date(friends.val().lastOnline);
            var serverTime = date.toLocaleString();
            //console.log('user is:  ' + friends.val().name + ' ,  by husnain');

            totalNotifications += friends.val().unread;

            if (friends.val().type === 'Private')
                var liTag = "<li class='" + friends.key + "'><a href = 'javascript:void(0)' id='btnRequest'  data-senderid = '" + SenderId + "' data-type=" + friends.val().type + " data-receiverid = '" + friends.key + "' data-receiverName = '" + friends.val().name + "' data-receiverPhoto = '" + friends.val().image + "' data-onlineStatus = '" + friends.val().Online + "' data-isgrpPublic = 'false' > <img src='" + friends.val().image + "' alt='user-img' class='img-circle'> <span> " + friends.val().name + " <small class='text-success'>" + friends.val().lastMessage + " <span > " + onlineTag + " <span class='label label-rouded label-danger' style='color:white'>" + friends.val().unread + "</span></span></small></span> </a> </li > ";
            else
                var liTag = "<li class='" + friends.key + "'><a href = 'javascript:void(0)' id='btnRequest'  data-senderid = '" + SenderId + "' data-type=" + friends.val().type + " data-receiverid = '" + friends.key + "' data-receiverName = '" + friends.val().name + "' data-receiverPhoto = '" + friends.val().image + "' data-onlineStatus = '" + friends.val().Online + "' data-isgrpPublic = 'false' > <img src='" + friends.val().image + "' alt='user-img' class='img-circle'> <span> " + friends.val().name + " <small class='text-success'>" + friends.val().lastMessage + " (GROUP) <span ><span class='label label-rouded label-danger' style='color:white'>" + friends.val().unread + "</span></span></small></span> </a> </li > ";


            $('.' + friends.key).remove();
            $("#binduser").append(liTag);
            $("#lblnotify").html(totalNotifications);
            if (totalNotifications === 0)
                $("#lblnotify1").html('');
            else
                $("#lblnotify1").html(totalNotifications);
        });

    }

    function AfterChanged() {
        $("#binduser").html('');

        totalNotifications = 0;
        $("#binduser").empty();

        var countArr = [];
        var getConnection = firebase.database().ref("TeleUsers/" + SenderId + "/Connections");
        getConnection.orderByChild('lastOnline').on('child_changed', function (friends) {


            if (friends.val().Online) {
                onlineTag = "<span class='text-success'>online</span>";
            }
            else {
                onlineTag = "<span class='text-muted'>offline</span>";
            }

            var date = new Date(friends.val().lastOnline);
            var serverTime = date.toLocaleString();
            // console.log('user is:  ' + friends.val().name + ' ,  by husnain');

            // totalNotifications = totalNotifications - friends.val().unread;
            totalNotifications = friends.val().unread;
            /*
            if (friends.val().type === 'Private')
                var liTag = "<li class='" + friends.key + "'><a href = 'javascript:void(0)' id='btnRequest'  data-senderid = '" + SenderId + "' data-type=" + friends.val().type + " data-receiverid = '" + friends.key + "' data-receiverName = '" + friends.val().name + "' data-receiverPhoto = '" + friends.val().image + "' data-onlineStatus = '" + friends.val().Online + "' > <img src='" + friends.val().image + "' alt='user-img' class='img-circle'> <span> " + friends.val().name + " <small class='text-success'>" + friends.val().lastMessage + " <span > " + onlineTag + " <span class='label label-rouded label-danger' style='color:white'>" + friends.val().unread + "</span></span></small></span> </a> </li > ";
            else
                var liTag = "<li class='" + friends.key + "'><a href = 'javascript:void(0)' id='btnRequest'  data-senderid = '" + SenderId + "' data-type=" + friends.val().type + " data-receiverid = '" + friends.key + "' data-receiverName = '" + friends.val().name + "' data-receiverPhoto = '" + friends.val().image + "' data-onlineStatus = '" + friends.val().Online + "' > <img src='" + friends.val().image + "' alt='user-img' class='img-circle'> <span> " + friends.val().name + " <small class='text-success'>" + friends.val().lastMessage + " (GROUP) <span ><span class='label label-rouded label-danger' style='color:white'>" + friends.val().unread + "</span></span></small></span> </a> </li > ";
                */

            if (friends.val().type === 'Private')
                var liTag = "<a href = 'javascript:void(0)' id='btnRequest'  data-senderid = '" + SenderId + "' data-type=" + friends.val().type + " data-receiverid = '" + friends.key + "' data-receiverName = '" + friends.val().name + "' data-receiverPhoto = '" + friends.val().image + "' data-onlineStatus = '" + friends.val().Online + "' data-isgrpPublic = 'false'> <img src='" + friends.val().image + "' alt='user-img' class='img-circle'> <span> " + friends.val().name + " <small class='text-success'>" + friends.val().lastMessage + " <span > " + onlineTag + " <span class='label label-rouded label-danger' style='color:white'>" + friends.val().unread + "</span></span></small></span> </a> ";
            else
                var liTag = "<a href = 'javascript:void(0)' id='btnRequest'  data-senderid = '" + SenderId + "' data-type=" + friends.val().type + " data-receiverid = '" + friends.key + "' data-receiverName = '" + friends.val().name + "' data-receiverPhoto = '" + friends.val().image + "' data-onlineStatus = '" + friends.val().Online + "' data-isgrpPublic = 'false'> <img src='" + friends.val().image + "' alt='user-img' class='img-circle'> <span> " + friends.val().name + " <small class='text-success'>" + friends.val().lastMessage + " (GROUP) <span ><span class='label label-rouded label-danger' style='color:white'>" + friends.val().unread + "</span></span></small></span> </a> ";

            // $("." + friends.key).remove();

            $("." + friends.key).html(liTag);
            // $("#binduser").append(liTag);



            $("#lblnotify").html(totalNotifications);
            if (totalNotifications === 0)
                $("#lblnotify1").html('');
            else
                $("#lblnotify1").html(totalNotifications);
        });
        /*
        debugger;
        for (var i = 0; i < countArr.length; i++) {

            var a = 0;
            if (countArr[i] === 0) {
                 a = totalNotifications - countArr[i].count;
            }
            if (countArr[i] === countArr.length - 1) {
                a = a + countArr[i].count;
                totalNotifications = a;

                $("#lblnotify").html(totalNotifications);
                if (totalNotifications === 0)
                    $("#lblnotify1").html('');
                else
                    $("#lblnotify1").html(totalNotifications);
            }
        }
        */
    }

    function GetTotalUnreadCount() {

        // debugger;
        totalNotifications = 0;

        var getConnection = firebase.database().ref("TeleUsers/" + SenderId + "/Connections");
        getConnection.on('child_added', function (friends) {


            totalNotifications += friends.val().unread;
            // console.log('total count is : ' + totalNotifications);
            $("#lblnotify").html(totalNotifications);
            if (totalNotifications === 0)
                $("#lblnotify1").html('');
            else
                $("#lblnotify1").html(totalNotifications);
        });

    }

    function GetChat(senderid, receiverid) {
        // debugger;

        $("#msgDetail").html('');
        $("#msgDetail").empty();


        var id = senderid + '-' + receiverid;
        var _id = receiverid + '-' + senderid;
        var status = 'not';

        var ref = firebase.database().ref("userMessages");
        ref.child(id).on("child_added", function (snapshot) {
            status = 'found';

            //console.log(snapshot.val().senderId);
            if (SenderId === snapshot.val().senderId) {
                //_senderName = snapshot.val().senderName;
                //_senderPhoto = snapshot.val().senderPhoto;
                _teleid = snapshot.val().teleid;
                var date = new Date(snapshot.val().dateTime);
                var serverTime = date.toLocaleString();
                //debugger;
                var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                if (record)
                    record = snapshot.val().msgType;
                else
                    record = '';

                var isCheck;
                if (snapshot.val().isRead)
                    isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                else
                    isCheck = "<i class='fa fa-check'></i>";


                var myfileTag;

                if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                    myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'pdf')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'text')
                    myfileTag = "<p> " + snapshot.val().message + " </p>";
                else
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";

                var liTag = "<li class='odd " + snapshot.key + "'><div class='chat-image'> <img src='" + _senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _senderName + "</h4> " + myfileTag + " <b>" + serverTime + " </b> <span>" + isCheck + "</span></div></div></li >";

                // console.log('(my record is) : ' + snapshot.val().message);
                $("." + snapshot.key).remove();
                $("#msgDetail").append(liTag);
                var messageBody = document.getElementById('msgDetail');
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
            }
            else {

                var date = new Date(snapshot.val().dateTime);
                var serverTime = date.toLocaleString();

                var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);

                if (record)
                    record = snapshot.val().msgType;
                else
                    record = '';

                var isCheck;
                if (snapshot.val().isRead)
                    isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                else
                    isCheck = "<i class='fa fa-check'></i>";

                var myfileTag;

                if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                    myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'pdf')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'text')
                    myfileTag = "<p> " + snapshot.val().message + " </p>";
                else
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";


                var liTag = "<li class='odduser " + snapshot.key + "'><div class='chat-image'> <img src='" + _receiverPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _receiverName + "</h4> " + myfileTag + " <b>" + serverTime + " </b><span>" + isCheck + "</span></div></div></li >";


                $("." + snapshot.key).remove();
                $("#msgDetail").append(liTag);
                var messageBody = document.getElementById('msgDetail');
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
            }

        });

        if (status !== 'found') {
            ref.child(_id).on("child_added", function (snapshot) {
                // console.log(snapshot.val().senderId);
                if (SenderId === snapshot.val().senderId) {
                    _senderName = snapshot.val().senderName;
                    _senderPhoto = snapshot.val().senderPhoto;
                    _teleid = snapshot.val().teleid;
                    var date = new Date(snapshot.val().dateTime);
                    var serverTime = date.toLocaleString();


                    var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                    if (record)
                        record = snapshot.val().msgType;
                    else
                        record = '';
                    //console.log('my record is : ' + record);

                    var isCheck;
                    if (snapshot.val().isRead)
                        isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                    else
                        isCheck = "<i class='fa fa-check'></i>";

                    var myfileTag;

                    if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                        myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                    else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                    else if (record === 'pdf')
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                    else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                    else if (record === 'text')
                        myfileTag = "<p> " + snapshot.val().message + " </p>";
                    else
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";


                    var liTag = "<li class='odd " + snapshot.key + "'><div class='chat-image'> <img src='" + _senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _senderName + "</h4>" + myfileTag + "<b>" + serverTime + " </b><span>" + isCheck + "</span></div></div></li >";

                    $("." + snapshot.key).remove();
                    $("#msgDetail").append(liTag);
                    var messageBody = document.getElementById('msgDetail');
                    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                }
                else {
                    var date = new Date(snapshot.val().dateTime);
                    var serverTime = date.toLocaleString();


                    var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                    if (record)
                        record = snapshot.val().msgType;
                    else
                        record = '';
                    //console.log('my record is : ' + record);

                    var isCheck;
                    if (snapshot.val().isRead)
                        isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                    else
                        isCheck = "<i class='fa fa-check'></i>";

                    var myfileTag;

                    if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                        myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                    else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                    else if (record === 'pdf')
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                    else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                    else if (record === 'text')
                        myfileTag = "<p> " + snapshot.val().message + " </p>";
                    else
                        myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";

                    var liTag = "<li class='odduser " + snapshot.key + "'><div class='chat-image'> <img  src='" + _receiverPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _receiverName + "</h4>" + myfileTag + " <b>" + serverTime + "</b><span>" + isCheck + "</span></div></div></li >";

                    $("." + snapshot.key).remove();
                    $("#msgDetail").append(liTag);
                    var messageBody = document.getElementById('msgDetail');
                    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                }
            });
        }

    }

    function SendMessage(id, _id, msg, type) {
        // debugger;
        var ref = firebase.database().ref("userMessages");
        ref.child(id).once('value', function (snapshot) {
            if (snapshot.val() !== null) {
                firebase.database().ref('userMessages').child(id).push({
                    isRead: false,
                    receiverId: _receiverId,
                    receiverName: _receiverName,
                    receiverPhoto: _receiverPhoto,
                    senderId: SenderId,
                    senderName: _senderName,
                    senderPhoto: _senderPhoto,
                    dateTime: firebase.database.ServerValue.TIMESTAMP,
                    teleid: _teleid,
                    message: msg,
                    type: 'Private',
                    msgType: type
                });
            }
            else {
                ref.child(_id).once('value', function (snapshot) {
                    if (snapshot.val() !== null) {
                        firebase.database().ref('userMessages').child(_id).push({
                            isRead: false,
                            receiverId: _receiverId,
                            receiverName: _receiverName,
                            receiverPhoto: _receiverPhoto,
                            senderId: SenderId,
                            senderName: _senderName,
                            senderPhoto: _senderPhoto,
                            dateTime: firebase.database.ServerValue.TIMESTAMP,
                            teleid: _teleid,
                            message: msg,
                            type: 'Private',
                            msgType: type
                        });
                    }
                    else {
                        firebase.database().ref('userMessages').child(id).push({
                            isRead: false,
                            receiverId: _receiverId,
                            receiverName: _receiverName,
                            receiverPhoto: _receiverPhoto,
                            senderId: SenderId,
                            senderName: _senderName,
                            senderPhoto: _senderPhoto,
                            dateTime: firebase.database.ServerValue.TIMESTAMP,
                            teleid: _teleid,
                            message: msg,
                            type: 'Private',
                            msgType: type
                        });
                    }
                });
            }
        });
        $("#txtMsg").val('');
    }

    function SendMessageNew(id, _id, msg, type) {
        // debugger;
        var refMsg = firebase.database().ref("userMessages");
        var ref = firebase.database().ref("TeleUsers/" + SenderId + '/ConnectionRules');
        ref.child(id).once('value', function (snapshot) {
            if (snapshot.val() !== null) {
                firebase.database().ref('userMessages').child(id).push({
                    isRead: false,
                    receiverId: _receiverId,
                    receiverName: _receiverName,
                    receiverPhoto: _receiverPhoto,
                    senderId: SenderId,
                    senderName: _senderName,
                    senderPhoto: _senderPhoto,
                    dateTime: firebase.database.ServerValue.TIMESTAMP,
                    teleid: _teleid,
                    message: msg,
                    type: 'Private',
                    msgType: type
                });
            }
            else {
                ref.child(_id).once('value', function (snapshot) {
                    if (snapshot.val() !== null) {
                        firebase.database().ref('userMessages').child(_id).push({
                            isRead: false,
                            receiverId: _receiverId,
                            receiverName: _receiverName,
                            receiverPhoto: _receiverPhoto,
                            senderId: SenderId,
                            senderName: _senderName,
                            senderPhoto: _senderPhoto,
                            dateTime: firebase.database.ServerValue.TIMESTAMP,
                            teleid: _teleid,
                            message: msg,
                            type: 'Private',
                            msgType: type
                        });
                    }
                    else {
                        firebase.database().ref('userMessages').child(id).push({
                            isRead: false,
                            receiverId: _receiverId,
                            receiverName: _receiverName,
                            receiverPhoto: _receiverPhoto,
                            senderId: SenderId,
                            senderName: _senderName,
                            senderPhoto: _senderPhoto,
                            dateTime: firebase.database.ServerValue.TIMESTAMP,
                            teleid: _teleid,
                            message: msg,
                            type: 'Private',
                            msgType: type
                        });
                    }
                });
            }
        });
        $("#txtMsg").val('');
    }

    function GetChatNew(senderid, receiverid) {
        // debugger;

        $("#msgDetail").html('');
        $("#msgDetail").empty();


        var id = senderid + '-' + receiverid;
        var _id = receiverid + '-' + senderid;
        var status = 'not';
        var foundId;

        var ref = firebase.database().ref("userMessages");

        var refConnection = firebase.database().ref("TeleUsers/" + SenderId + '/ConnectionRules');
        refConnection.child(id).on('value', function (data) {
            if (data.val() !== null) {
                foundId = id;
                ref.child(foundId).on("child_added", function (snapshot) {

                    if (SenderId === snapshot.val().senderId) {
                        _teleid = snapshot.val().teleid;
                        var date = new Date(snapshot.val().dateTime);
                        var serverTime = date.toLocaleString();
                        var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                        if (record)
                            record = snapshot.val().msgType;
                        else
                            record = '';

                        var isCheck;
                        if (snapshot.val().isRead)
                            isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                        else
                            isCheck = "<i class='fa fa-check'></i>";


                        var myfileTag;

                        if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                            myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                        else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                        else if (record === 'pdf')
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                        else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                        else if (record === 'text')
                            myfileTag = "<p> " + snapshot.val().message + " </p>";
                        else
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";

                        var liTag = "<li class='odd " + snapshot.key + "'><div class='chat-image'> <img src='" + _senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _senderName + "</h4> " + myfileTag + " <b>" + serverTime + " </b> <span>" + isCheck + "</span></div></div></li >";

                        // console.log('(my record is) : ' + snapshot.val().message);
                        $("." + snapshot.key).remove();
                        $("#msgDetail").append(liTag);
                        var messageBody = document.getElementById('msgDetail');
                        messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                    }
                    else {

                        var date = new Date(snapshot.val().dateTime);
                        var serverTime = date.toLocaleString();

                        var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);

                        if (record)
                            record = snapshot.val().msgType;
                        else
                            record = '';

                        var isCheck;
                        if (snapshot.val().isRead)
                            isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                        else
                            isCheck = "<i class='fa fa-check'></i>";

                        var myfileTag;

                        if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                            myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                        else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                        else if (record === 'pdf')
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                        else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                        else if (record === 'text')
                            myfileTag = "<p> " + snapshot.val().message + " </p>";
                        else
                            myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";


                        var liTag = "<li class='odduser " + snapshot.key + "'><div class='chat-image'> <img src='" + _receiverPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _receiverName + "</h4> " + myfileTag + " <b>" + serverTime + " </b><span>" + isCheck + "</span></div></div></li >";


                        $("." + snapshot.key).remove();
                        $("#msgDetail").append(liTag);
                        var messageBody = document.getElementById('msgDetail');
                        messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                    }

                });
            }
            else {
                refConnection.child(_id).on('value', function (collect) {
                    foundId = _id;
                    ref.child(foundId).on("child_added", function (snapshot) {
                        // console.log(snapshot.val().senderId);
                        if (SenderId === snapshot.val().senderId) {
                            _senderName = snapshot.val().senderName;
                            _senderPhoto = snapshot.val().senderPhoto;
                            _teleid = snapshot.val().teleid;
                            var date = new Date(snapshot.val().dateTime);
                            var serverTime = date.toLocaleString();


                            var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                            if (record)
                                record = snapshot.val().msgType;
                            else
                                record = '';
                            //console.log('my record is : ' + record);

                            var isCheck;
                            if (snapshot.val().isRead)
                                isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                            else
                                isCheck = "<i class='fa fa-check'></i>";

                            var myfileTag;

                            if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                                myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                            else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                            else if (record === 'pdf')
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                            else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                            else if (record === 'text')
                                myfileTag = "<p> " + snapshot.val().message + " </p>";
                            else
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";


                            var liTag = "<li class='odd " + snapshot.key + "'><div class='chat-image'> <img src='" + _senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _senderName + "</h4>" + myfileTag + "<b>" + serverTime + " </b><span>" + isCheck + "</span></div></div></li >";

                            $("." + snapshot.key).remove();
                            $("#msgDetail").append(liTag);
                            var messageBody = document.getElementById('msgDetail');
                            messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                        }
                        else {
                            var date = new Date(snapshot.val().dateTime);
                            var serverTime = date.toLocaleString();


                            var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                            if (record)
                                record = snapshot.val().msgType;
                            else
                                record = '';
                            //console.log('my record is : ' + record);

                            var isCheck;
                            if (snapshot.val().isRead)
                                isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                            else
                                isCheck = "<i class='fa fa-check'></i>";

                            var myfileTag;

                            if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp')
                                myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                            else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                            else if (record === 'pdf')
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                            else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                            else if (record === 'text')
                                myfileTag = "<p> " + snapshot.val().message + " </p>";
                            else
                                myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";

                            var liTag = "<li class='odduser " + snapshot.key + "'><div class='chat-image'> <img  src='" + _receiverPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _receiverName + "</h4>" + myfileTag + " <b>" + serverTime + "</b><span>" + isCheck + "</span></div></div></li >";

                            $("." + snapshot.key).remove();
                            $("#msgDetail").append(liTag);
                            var messageBody = document.getElementById('msgDetail');
                            messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                        }
                    });
                });
            }
        });

    }

    function GetPerson(type) {
        //debugger;
        var index = _allGroup.map(e => e.grpid).indexOf(_receiverId);
        var record = _allGroup[index];
        if (record) {
            if (record.admin === SenderId)
                _userType = 'Admin';
            else
                _userType = 'user';
        }
        else
            _userType = 'user';


        if (_userType === "Admin") {
            addTag = "<a href='javascript:void(0)' id='addUserToGrp' class='cst-icon' target='_blank' data-toggle='modal' data-target='.bs-example-modal-lg1' data-id '" + _receiverId + "' title='Add Users' > <img style='float: right' src='/Content/images/add.png' height='20' width = '20' alt='Add Users'/> </a>";
        }
        else {
            addTag = '';
        }
        if (type === 'Private') {
            if (_isOnline == 'true') {
                onlineTag = "<span class='text-success'>online</span>";
            }
            else {
                onlineTag = "<span class='text-muted'>offline</span>";
            }
        }
        else {
            onlineTag = "<span class='text-success'>GROUP</span>";
        }

        liTag = "<div> <img src='" + _receiverPhoto + "' alt='user-img' class='img-circle'> <span> " + _receiverName + "<small class='text-success'>&nbsp; " + onlineTag + "</small></span> " + addTag + "  </div>";
        $(".box-title").hide();
        $("#person").html(liTag);

    }

    function UserConnections(shortmsg) {
        // debugger;
        var _type = '';
        if (isGroup)
            _type = 'Public';
        else
            _type = 'Private';

        var ref = firebase.database().ref("TeleUsers/" + SenderId + '/Connections');
        ref.child(_receiverId).update({
            lastOnline: firebase.database.ServerValue.TIMESTAMP,
            name: _receiverName,
            image: _receiverPhoto,
            lastMessage: shortmsg,
            type: _type,
            msgNode: SenderId + '-' + _receiverId
        }).then(function () {
            if (_type === 'Private')
                return ref.child(SenderId).once("value");
            else
                return ref.child(_receiverId).once("value");
        }).then(function (snapshot) {
            //debugger;
            var data = snapshot.val();
            var time = snapshot.val().lastOnline;
            //console.log('my local time is : ' + time);
            var reff = firebase.database().ref("TeleUsers/" + SenderId + '/Connections');
            reff.child(_receiverId).update({
                lastOnline: time * -1
            });

            // AfterModify();
        });
        if (isGroup) {
            LoadGrpUsers(shortmsg);

            var refRule = firebase.database().ref("TeleUsers/" + SenderId + '/ConnectionRules');
            refRule.child(_receiverId).update({
                msgNode: _receiverId
            });
        }

        if (isGroup === false) {
            var ref = firebase.database().ref("TeleUsers/" + _receiverId + '/Connections');
            ref.child(SenderId).update({
                lastOnline: firebase.database.ServerValue.TIMESTAMP,
                name: _senderName,
                image: _senderPhoto,
                lastMessage: shortmsg,
                type: _type
            }).then(function () {
                return ref.child(SenderId).once("value");
            }).then(function (snapshot) {
                // debugger;
                var data = snapshot.val();
                var time = snapshot.val().lastOnline;
                var unread = snapshot.val().unread;
                if (unread)
                    unread += 1;
                else
                    unread = 1;
                //console.log('my local time is : ' + time);
                var reff = firebase.database().ref("TeleUsers/" + _receiverId + '/Connections');
                reff.child(SenderId).update({
                    lastOnline: time * -1,
                    unread: unread
                });
                // AfterModify();
            });



            var id = SenderId + "-" + _receiverId;
            var _id = _receiverId + "-" + SenderId;
            // debugger;
            var isExist = "not";

            var getRule = firebase.database().ref("TeleUsers/" + SenderId + '/ConnectionRules');
            getRule.child(id).on('value', function (snapshot) {
                if (snapshot.val() !== null) {
                    isExist = 'found';
                    // console.log('value is : ' + isExist + ' ,  ' + snapshot.key);
                }
                else {
                    getRule.child(_id).on('value', function (data) {
                        if (data.val() !== null) {
                            isExist = '_found';
                            //  console.log('value is : ' + isExist + ' ,  ' + data.key);
                        }
                        else {
                            isExist = 'noFound';
                        }
                    });
                }
            });

            /*
            if (isExist === 'noFound') {
                var _getRule = firebase.database().ref("TeleUsers/" + SenderId + '/ConnectionRules');
                _getRule.child(_id).on('value', function (snapshot) {
                    isExist = '_found';
                    console.log('value is : ' + isExist + ' ,  ' + snapshot.key);
                });
            }
            */

            if (isExist === 'noFound') {
                var refRule = firebase.database().ref("TeleUsers/" + SenderId + '/ConnectionRules');
                refRule.child(id).update({
                    msgNode: id
                });

                var refRule = firebase.database().ref("TeleUsers/" + _receiverId + '/ConnectionRules');
                refRule.child(id).update({
                    msgNode: id
                });
            }



        }




    }

    function SearchUser(name) {


        //var ref = firebase.database().ref("TeleUsers");
        //ref.orderByChild("teleid").equalTo(_teleid).on("child_added", function (snapshot) {

        //});
    }

    function CreateGroup(name) {

        firebase.database().ref('Groups').push({
            groupName: name,
            createdBy: SenderId,
            id: SenderId,
            teleid: _teleid,
            type: 'Admin',
            userName: _senderName,
            image: _senderPhoto,
            dateTime: firebase.database.ServerValue.TIMESTAMP
        });

    }

    function AddUserToGroup(userid, name, image, grpid, nodeid, grpname) {

        firebase.database().ref('Group-users').child(nodeid).set({
            id: userid,
            teleid: _teleid,
            groupId: grpid,
            groupName: grpname,
            type: 'user',
            userName: name,
            image: image,
            dateTime: firebase.database.ServerValue.TIMESTAMP
        });
    }

    function DeleteUserFromGroup(grpid, nodeid) {
        firebase.database().ref('Groups/' + grpid + '/users').child(nodeid).remove();
        firebase.database().ref('TeleUsers/' + nodeid + '/Connections').child(grpid).remove();
        firebase.database().ref('TeleUsers/' + nodeid + '/ConnectionRules').child(grpid).remove();
    }

    function GroupMessages(grpid, msg) {

        firebase.database().ref('Groups/' + grpid + '/Messages').push({
            isRead: false,
            senderId: SenderId,
            senderName: _senderName,
            senderPhoto: _senderPhoto,
            dateTime: firebase.database.ServerValue.TIMESTAMP,
            teleid: _teleid,
            message: msg
        });
        $("#txtMsg").val('');
    }

    function LoadGroup() {
        //debugger;
        var userType;
        var ref = firebase.database().ref("Groups");
        ref.orderByChild('id').equalTo(SenderId).on("child_added", function (snapshot) {
            userType = 'Admin';
            _userType = 'Admin';
            teleUsersArr.push({ id: snapshot.key, name: snapshot.val().groupName, image: snapshot.val().image });
            var liTag = "<li><a href = 'javascript:void(0)' id='btnRequest' data-senderid = '" + SenderId + "' data-receiverid = '" + snapshot.key + "' data-type='group'  data-receiverName = '" + snapshot.val().groupName + "' data-receiverPhoto = '" + snapshot.val().image + "'  data-isgrpPublic = 'false'> <img src='" + snapshot.val().image + "' alt='user-img' class='img-circle'> <span> " + snapshot.val().groupName + "<small class='text-success'>GROUP</small></span></a></li > ";
            // $("#binduser").append(liTag);
        });
        if (userType !== 'Admin') {
            var refuser = firebase.database().ref("Group-users");
            refuser.orderByChild('id').equalTo(SenderId).on("child_added", function (snapshot) {
                teleUsersArr.push({ id: snapshot.val().groupId, name: snapshot.val().groupName, image: snapshot.val().image });
                var liTag = "<li><a href = 'javascript:void(0)' id='btnRequest' data-senderid = '" + SenderId + "' data-receiverid = '" + snapshot.val().groupId + "' data-type='group' data-receiverName = '" + snapshot.val().groupName + "' data-receiverPhoto = '" + snapshot.val().image + "' data-isgrpPublic = 'false'> <img src='" + snapshot.val().image + "' alt='user-img' class='img-circle'> <span> " + snapshot.val().groupName + "<small class='text-success'>GROUP</small></span></a></li > ";
                // $("#binduser").append(liTag);
            });
        }
    }

    function UpdateGroup() {
        var name = 'Hawk Logix';
        var grpid = '-LXYPYm0QxFQEI9UhHt8';
        firebase.database().ref('Groups/' + grpid).update({
            groupName: name,
            createdBy: SenderId,
            id: SenderId,
            teleid: _teleid,
            type: 'Admin',
            userName: _senderName,
            image: _senderPhoto,
            dateTime: firebase.database.ServerValue.TIMESTAMP
        });
    }

    function GetGroupChat(senderid, receiverid) {
        $("#msgDetail").html('');
        var ref = firebase.database().ref("Groups/" + receiverid + "/Messages");
        ref.on("child_added", function (snapshot) {
            if (SenderId === snapshot.val().senderId) {
                _senderName = snapshot.val().senderName;
                _senderPhoto = snapshot.val().senderPhoto;
                _teleid = snapshot.val().teleid;
                var date = new Date(snapshot.val().dateTime);
                var serverTime = date.toLocaleString();
                var liTag = "<li class='odd'><div class='chat-image'> <img src='" + snapshot.val().senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + snapshot.val().senderName + "</h4><p> " + snapshot.val().message + " </p> <b>" + serverTime + " </b></div></div></li >";
                $("#msgDetail").append(liTag);
                var messageBody = document.getElementById('msgDetail');
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
            }
            else {
                var date = new Date(snapshot.val().dateTime);
                var serverTime = date.toLocaleString();
                var liTag = "<li class='odduser'><div class='chat-image'> <img src='" + snapshot.val().senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + snapshot.val().senderName + "</h4><p> " + snapshot.val().message + " </p> <b>" + serverTime + " </b></div></div></li >";
                $("#msgDetail").append(liTag);
                var messageBody = document.getElementById('msgDetail');
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
            }
        });


    }

    function GetGroupUsers() {

        $("#userlistforGrp").html('');
        var grpId = _receiverId;

        var j = 1;

        for (var i = 0; i < teleUsersForGrpArr.length; i++) {
            var _userid = teleUsersForGrpArr[i].id;
            var _photo = teleUsersForGrpArr[i].image;
            var _name = teleUsersForGrpArr[i].name;
            var checkExist = _userid + '-' + grpId;

            var exist = groupUsers.map(e => e.id).indexOf(checkExist);
            if (exist > -1) {
                var liTag = "<li> <div class='col-md-12'> <div class='col-md-8'> <a href = 'javascript:void(0)'  data-senderid = '" + SenderId + "' data-receiverid = '" + _userid + "' data-receiverName = '" + _name + "' data-receiverPhoto = '" + _photo + "'  > <img src='" + _photo + "' alt='user-img' class='img-circle'> <span> " + _name + "</span></a> </div> <div class='col-md-4 checkbox checkbox-success'><input id = 'checkbox3" + j + "' type ='checkbox' class='Addusers' data-usrid='" + _userid + "' data-usrname='" + _name + "' data-usrimage='" + _photo + "' data-loop='" + j + "' checked ><label for='checkbox3'> </label></div> </div> </li > ";
                $("#userlistforGrp").append(liTag);
            }
            else {
                var liTag = "<li> <div class='col-md-12'><div class='col-md-8'> <a href = 'javascript:void(0)' data-senderid = '" + SenderId + "' data-receiverid = '" + _userid + "' data-receiverName = '" + _name + "' data-receiverPhoto = '" + _photo + "'  > <img src='" + _photo + "' alt='user-img' class='img-circle'> <span> " + _name + "</span></a> </div> <div class='col-md-4 checkbox checkbox-success'><input id = 'checkbox3" + j + "' type ='checkbox' class='Addusers' data-usrid='" + _userid + "' data-usrname='" + _name + "' data-usrimage='" + _photo + "' data-loop='" + j + "'><label for='checkbox3'>  </label></div> </div></li > ";
                $("#userlistforGrp").append(liTag);
            }
            j++;
        }
    }

    $(document).on('change', ".Addusers", function () {

        var _userid = $(this).attr("data-usrid");
        var _name = $(this).attr("data-usrname");
        var _image = $(this).attr("data-usrimage");

        var loop = $(this).attr("data-loop");

        var grpId = _receiverId;

        var nodeid = _userid + '-' + grpId;
        var grpname = _receiverName;

        var isChecked = document.getElementById("checkbox3" + loop).checked;
        if (isChecked) {
            // AddUserToGroup(_userid, _name, _image, grpId, nodeid, grpname);
            AddUserToGroupNew(_userid, _name, _image, grpId, nodeid, grpname);
        }
        else {
            DeleteUserFromGroup(grpId, _userid);
        }


    });


    function ReadMessageStatus(SenderId, _receiverId) {
        // debugger;
        var _status = 'not';
        var _unreadMsg = [];
        var id = SenderId + '-' + _receiverId;
        var _id = _receiverId + '-' + SenderId;

        var ref = firebase.database().ref("userMessages/" + id);
        ref.orderByChild('receiverId').equalTo(SenderId).on('child_added', function (snapshot) {
            _status = 'found';
            var count = 0;

            if (snapshot.val().isRead === false) {
                count++;
                //unreadMsg.push({ msgid: snapshot.key })
            }
            unreadMessage = count;
        });
        if (_status !== 'found') {
            var ref = firebase.database().ref("userMessages");
            ref.child(_id).on("child_added", function (snapshot) {
                if (SenderId === snapshot.val().receiverId) {
                    if (snapshot.val().isRead === false) {
                        unreadMsg.push({ id: snapshot.val().receiverId })
                        unreadMessage++;
                        firebase.database().ref("TeleUsers/" + SenderId + "/Connections").child(_receiverId).update({
                            unread: unreadMessage
                        });
                        //console.log('my msg is : ' + unreadMessage);
                    }
                    else {
                        //unreadMessage++;
                        // console.log('my else msg is : ' + unreadMessage);
                    }
                }
            });

            /*
            var ref = firebase.database().ref("userMessages/" + _id);
            ref.orderByChild('receiverId').equalTo(SenderId).on('child_added', function (snapshot) {
                var count = 0;
                snapshot.forEach(function () {
                    if (snapshot.val().isRead === false) {
                        count++;
                        //unreadMsg.push({ msgid: snapshot.key })
                    }
                });

                unreadMessage = count;
            });
            */
        }

        //console.log('My Msg count is : ' + unreadMessage);
        //return unreadMessage;
    }

    function UpdateReadStatus(type) {
        // debugger;
        if (type === 'Private') {


            var id = SenderId + '-' + _receiverId;
            var _id = _receiverId + '-' + SenderId;
            var status = 'not';

            var ref = firebase.database().ref("userMessages/" + id);
            ref.orderByChild('receiverId').equalTo(SenderId).on('child_added', function (snapshot) {
                status = 'found';
                var _ref = firebase.database().ref("userMessages/" + id);
                // console.log('update msg id : ' + snapshot.key);
                _ref.child(snapshot.key).update({
                    isRead: true
                });
            });


            if (status !== 'found') {
                var _ref = firebase.database().ref("userMessages/" + _id);
                _ref.orderByChild('receiverId').equalTo(SenderId).on('child_added', function (snapshot) {
                    var _ref = firebase.database().ref("userMessages/" + _id + "/" + snapshot.key);
                    // console.log('id is ; ' + snapshot.key);
                    _ref.update({
                        isRead: true
                    });

                });

            }
        }
        else if (type === 'Public') {
            UpdateGroupChat(_receiverId);
        }
        firebase.database().ref("TeleUsers/" + SenderId + "/Connections").child(_receiverId).update({
            unread: 0
        });

    }

    function UnreadMessages(senderid, receiverid) {
        var unreadMsg = [];
        var id = senderid + '-' + receiverid;
        var _id = receiverid + '-' + senderid;

        var ref = firebase.database().ref("userMessages/" + id);
        ref.orderByChild('receiverId').equalTo(senderid).on('child_added', function (snapshot) {
            //console.log(snapshot.val().isRead);
            if (snapshot.val().isRead === false) {
                unreadMsg.push({ msgid: snapshot.key })
            }
        });

        var _unread = unreadMsg.length;
        //console.log(_unread);
        return _unread;
    }

    //******************************* New Integration Started ***************************//

    function AddUserToGroupNew(userid, name, image, grpid, nodeid, grpname) {

        firebase.database().ref('Groups/' + grpid + '/users').child(userid).set({
            id: userid,
            teleid: _teleid,
            groupId: grpid,
            groupName: grpname,
            type: 'user',
            userName: name,
            image: image,
            dateTime: firebase.database.ServerValue.TIMESTAMP
        });

        var ref = firebase.database().ref("TeleUsers/" + userid + "/Connections");
        ref.child(grpid).set({
            lastOnline: firebase.database.ServerValue.TIMESTAMP,
            name: grpname,
            image: _receiverPhoto,
            lastMessage: '',
            type: 'Public'
        });

        var refRule = firebase.database().ref("TeleUsers/" + userid + "/ConnectionRules");
        refRule.child(grpid).set({
            msgNode: grpid
        });
    }

    function LoadGroupNew() {
        //  debugger;
        var userType;
        var ref = firebase.database().ref("Groups");
        ref.on("child_added", function (snapshot) {
            ref.child(snapshot.key).child('users').on('child_added', function (data) {
                //console.log(data.key);
                if (data.key === SenderId) {
                    _userType = data.val().type;
                    teleUsersArr.push({ id: snapshot.key, name: data.val().groupName, image: data.val().image });
                    //var userRef = firebase.database().ref("TeleUsers/" + SenderId + "/Connections");
                    //userRef.child(snapshot.key).on('value', function (_data) {
                    //    console.log('My Value is : ' + _data.key);
                    //    var liTag = "<li><a href = 'javascript:void(0)' id='btnRequest' data-senderid = '" + SenderId + "' data-receiverid = '" + snapshot.key + "' data-type='group'  data-receiverName = '" + data.val().groupName + "' data-receiverPhoto = '" + data.val().image + "'  > <img src='" + data.val().image + "' alt='user-img' class='img-circle'> <span> " + data.val().groupName + "<small class='text-success'> " + _data.val().lastMessage + " (GROUP)</small></span></a></li > ";
                    //    $("#binduser").append(liTag);
                    //});

                }
            });


        });

    }

    function CreateGroupNew(name, grptype) {
        var getkey = firebase.database().ref().child("Groups").push().key;
        firebase.database().ref('Groups').child(getkey).set({
            groupName: name,
            createdBy: SenderId,
            id: SenderId,
            teleid: _teleid,
            type: 'Admin',
            userName: _senderName,
            image: '/Content/images/group.png',//_senderPhoto,
            dateTime: firebase.database.ServerValue.TIMESTAMP,
            grpType: grptype
        });
        firebase.database().ref('Groups/' + getkey + '/users/').child(SenderId).set({
            id: SenderId,
            groupName: name,
            teleid: _teleid,
            type: 'Admin',
            userName: _senderName,
            image: _senderPhoto,
            dateTime: firebase.database.ServerValue.TIMESTAMP
        });

        GetGroupByKey(getkey);
    }

    function GetGroupByKey(key) {
        //debugger;
        var ref = firebase.database().ref("Groups/" + key);
        ref.on('value', function (data) {
            _receiverId = data.key;
            _receiverName = data.val().groupName;
            _receiverPhoto = data.val().image;
            isGroup = true;
        });
        var txt = '';
        UserConnections(txt);
    }

    function GroupMessages(grpid, msg) {
        firebase.database().ref('Groups/' + grpid + '/Messages').push({
            isRead: false,
            senderId: SenderId,
            senderName: _senderName,
            senderPhoto: _senderPhoto,
            dateTime: firebase.database.ServerValue.TIMESTAMP,
            teleid: _teleid,
            message: msg
        });
        $("#txtMsg").val('');
    }

    function _GetGroupUsers(_groupUsers) {
        $("#userlistforGrp").html('');
        var grpId = _receiverId;

        var j = 1;

        for (var i = 0; i < teleUsersForGrpArr.length; i++) {
            var _userid = teleUsersForGrpArr[i].id;
            var _photo = teleUsersForGrpArr[i].image;
            var _name = teleUsersForGrpArr[i].name;
            var checkExist = _userid + '-' + grpId;
            var exist = _groupUsers.map(e => e.id).indexOf(_userid);
            if (exist > -1) {
                var liTag = "<li> <div class='row col-md-12'> <div style='width:80%'> <a href = 'javascript:void(0)'  data-senderid = '" + SenderId + "' data-receiverid = '" + _userid + "' data-receiverName = '" + _name + "' data-receiverPhoto = '" + _photo + "'  > <img src='" + _photo + "' alt='user-img' class='img-circle'> <span> " + _name + "</span></a> </div> <div class='checkbox checkbox-success'><input id = 'checkbox3" + j + "' type ='checkbox' class='Addusers' data-usrid='" + _userid + "' data-usrname='" + _name + "' data-usrimage='" + _photo + "' data-loop='" + j + "' checked ><label for='checkbox3'> </label></div> </div> </li > ";
                $("#userlistforGrp").append(liTag);
            }
            else {
                var liTag = "<li> <div class='row col-md-12'><div style='width:80%'> <a href = 'javascript:void(0)' data-senderid = '" + SenderId + "' data-receiverid = '" + _userid + "' data-receiverName = '" + _name + "' data-receiverPhoto = '" + _photo + "'  > <img src='" + _photo + "' alt='user-img' class='img-circle'> <span> " + _name + "</span></a> </div> <div class='checkbox checkbox-success'><input id = 'checkbox3" + j + "' type ='checkbox' class='Addusers' data-usrid='" + _userid + "' data-usrname='" + _name + "' data-usrimage='" + _photo + "' data-loop='" + j + "'><label for='checkbox3'>  </label></div> </div></li > ";
                $("#userlistforGrp").append(liTag);
            }
            j++;
        }
    }

    function _LoadGrpUsers() {
        var _groupUsers = [];
        var grpId = _receiverId;
        var ref = firebase.database().ref("Groups/" + grpId + "/users");
        ref.on("child_added", function (snapshot) {
            _groupUsers.push({ id: snapshot.key });
        });
        _GetGroupUsers(_groupUsers);
    }


    function _GroupMessages(grpid, msg, type) {
        firebase.database().ref('userMessages/' + grpid).push({
            isRead: false,
            grpId: grpid,
            senderId: SenderId,
            read: false,
            senderName: _senderName,
            senderPhoto: _senderPhoto,
            dateTime: firebase.database.ServerValue.TIMESTAMP,
            teleid: _teleid,
            message: msg,
            type: 'Public',
            msgType: type
        });
        $("#txtMsg").val('');
    }

    function isAdmin() {
        var ref = firebase.database().ref("Groups");
        ref.child(_receiverId).on('value', function (data) {
            if (data.val().id === SenderId)
                _userType = 'Admin';
            else
                _userType = 'user';
        });
    }

    function _GetGroupChat(senderid, receiverid) {
        $("#msgDetail").html('');
        var ref = firebase.database().ref("userMessages/" + receiverid);
        ref.on("child_added", function (snapshot) {
            if (SenderId === snapshot.val().senderId) {
                //_senderName = snapshot.val().senderName;
                //_senderPhoto = snapshot.val().senderPhoto;
                _teleid = snapshot.val().teleid;
                var date = new Date(snapshot.val().dateTime);
                var serverTime = date.toLocaleString();


                var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                if (record)
                    record = snapshot.val().msgType;
                else
                    record = '';
                // console.log('my group record is : ' + record);
                var isCheck;
                if (snapshot.val().isRead)
                    isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                else
                    isCheck = "<i class='fa fa-check'></i>";

                var myfileTag;

                if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                    myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'pdf')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'text')
                    myfileTag = "<p> " + snapshot.val().message + " </p>";
                else
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";


                var liTag = "<li class='odd " + snapshot.key + "'><div class='chat-image'> <img src='" + _senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + _senderName + "</h4>" + myfileTag + "  <b>" + serverTime + " </b><span>" + isCheck + "</span></div></div></li >";

                $("." + snapshot.key).remove();
                $("#msgDetail").append(liTag);
                var messageBody = document.getElementById('msgDetail');
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
            }
            else {
                var date = new Date(snapshot.val().dateTime);
                var serverTime = date.toLocaleString();


                var record = (FileExtensions.indexOf(snapshot.val().msgType) > -1);
                if (record)
                    record = snapshot.val().msgType;
                else
                    record = '';
                //console.log('my group record is : ' + record);
                var isCheck;
                if (snapshot.val().isRead)
                    isCheck = "<i class='fa fa-check'></i><i class='fa fa-check'></i>";
                else
                    isCheck = "<i class='fa fa-check'></i>";

                var myfileTag;

                if (record === 'jpg' || record === 'png' || record === 'jpeg' || record === 'gif' || record === 'bmp' || record === 'JPG' || record === 'PNG')
                    myfileTag = "<img src='" + snapshot.val().message + "' style='height:100px;width:100px'/>";
                else if (record === 'doc' || record === 'docx' || record === 'docs' || record === 'docm' || record === 'dotx' || record === 'dotm' || record === 'docb')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'> <img src='/content/images/worddocx.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'pdf')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/pdf_4.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'xlsx' || record === 'xlx' || record === 'xlsb' || record === 'xlsm')
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/excel.png' style='height:100px;width:100px'/> </a>";
                else if (record === 'text')
                    myfileTag = "<p> " + snapshot.val().message + " </p>";
                else
                    myfileTag = "<a href='" + snapshot.val().message + "' target='_blank'><img src='/content/images/other.png' style='height:100px;width:100px'/> </a>";

                var liTag = "<li class='odduser " + snapshot.key + "'><div class='chat-image'> <img src='" + snapshot.val().senderPhoto + "'></div><div class='chat-body'><div class='chat-text'><h4>" + snapshot.val().senderName + "</h4>" + myfileTag + " <b>" + serverTime + " </b><span>" + isCheck + "</span></div></div></li >";

                $("." + snapshot.key).remove();
                $("#msgDetail").append(liTag);
                var messageBody = document.getElementById('msgDetail');
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                var users = '';
                ref.child(snapshot.key).child('read').on('child_added', function (seenUser) {
                    // console.log('seen Users is : ' + seenUser.val().name);
                    users += seenUser.val().name + ', ';
                });
                var _text = "<li class='centerAlignSeen'><span > Seen By " + users + " </span></li>";
                $("#msgDetail").append(_text);
            }
        });


    }

    function _SignInStatus() {
        var ref = firebase.database().ref("TeleUsers");
        ref.on("child_added", function (snapshot) {
            ref.child(snapshot.key).child('Connections').on('child_added', function (data) {
                // console.log(data.key);
                if (data.key === SenderId) {
                    var _ref = firebase.database().ref("TeleUsers/" + snapshot.key + "/Connections");
                    _ref.child(SenderId).update({
                        Online: true,
                        lastOnline: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        });
    }

    function _SignOutStatus() {
        var ref = firebase.database().ref("TeleUsers");
        ref.on("child_added", function (snapshot) {
            ref.child(snapshot.key).child('Connections').on('child_added', function (data) {
                //  console.log(data.key);
                if (data.key === SenderId) {
                    var _ref = firebase.database().ref("TeleUsers/" + snapshot.key + "/Connections");
                    _ref.child(SenderId).update({
                        Online: false,
                        lastOnline: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        });
    }

    function GetAllGroups() {
        var ref = firebase.database().ref("Groups");
        ref.on('child_added', function (data) {
            const checkGrpExist = _allGroup.some(x => x.grpid == data.key);
            if (!checkGrpExist)
                _allGroup.push({ grpid: data.key, grpname: data.val().groupName, img: data.val().image, admin: data.val().id, searchgrpname: data.val().groupName.toLowerCase() });
        });
        GetPublicGroups();
    }
    function GetPublicGroups() {
        let ref = firebase.database().ref("Groups");
        ref.orderByChild("grpType").equalTo('Public').on("child_added", function (data) {
            const checkGrpExist = publicGrpArr.some(x => x.grpid == data.key);
            if (!checkGrpExist)
                publicGrpArr.push({ grpid: data.key, grpname: data.val().groupName, img: data.val().image, admin: data.val().id, searchgrpname: data.val().groupName.toLowerCase() });
        });
    }

    function UpdateGroupChat(grpid) {
        //debugger;
        var ref = firebase.database().ref("userMessages/" + grpid);
        ref.on("child_added", function (snapshot) {
            // console.log('key is : ' + snapshot.key);
            ref.child(snapshot.key).child('read/' + SenderId).set({
                id: SenderId,
                name: _senderName
            });
        });

    }

    function GetUnreadGrpMsg(grpid) {
        // debugger;
        var mycount = 1;
        var countTotal = 0;
        var _arr = [];
        var ref = firebase.database().ref("userMessages/" + grpid);
        ref.on('child_added', function (snapshot) {
            var status = false;
            ref.child(snapshot.key).child('read').child(SenderId).on('child_added', function (data) {
                status = true;
                // console.log('snapshot data is :' + data.key + ' :' + snapshot.key);
            });
            if (status === false) {
                countTotal++;
            }
            //  console.log('total unread msg : ' + countTotal);
        });
        return countTotal;
    }

    function LoadGrpUsers(shortmsg) {
        // debugger;
        var _Users = [];
        var grpId = _receiverId;
        var ref = firebase.database().ref("Groups/" + grpId + "/users");
        ref.on("child_added", function (snapshot) {
            //_Users.push({ id: snapshot.key });
            var id = snapshot.key;
            if (id !== SenderId) {
                var ref = firebase.database().ref("TeleUsers/" + id + '/Connections');
                ref.child(grpId).update({
                    lastOnline: firebase.database.ServerValue.TIMESTAMP,
                    lastMessage: shortmsg,
                    type: 'Public'
                }).then(function () {
                    return ref.child(grpId).once("value");
                }).then(function (snapshot) {
                    // debugger;
                    var data = snapshot.val();
                    var time = snapshot.val().lastOnline;
                    var unread = snapshot.val().unread;
                    if (unread)
                        unread += 1;
                    else
                        unread = 1;
                    //console.log('my local time is : ' + time);
                    var reff = firebase.database().ref("TeleUsers/" + id + '/Connections');
                    reff.child(grpId).update({
                        lastOnline: time * -1,
                        unread: unread
                    });

                });
            }
        });
        //UpdateUnreadCountForGroupUsers(grpId, _Users, shortmsg);
    }

    function checkAllgrpUserReadMsg(grpid) {
        //******************* Method One **********************************//
        var _grpArr = [];
        var groupUser = firebase.database().ref("Groups/" + grpid + "/users");
        groupUser.on('child_added', function (grpUser) {
            _grpArr.push({ id: grpUser.key });
        });

        var ref = firebase.database().ref("userMessages/" + grpid);
        ref.on("child_added", function (snapshot) {
            //console.log('_grpArr is : ' + _grpArr);
            var msgArr = [];
            for (var i = 0; i < _grpArr.length; i++) {
                var Alluser = 'notFound';
                ref.child(snapshot.key + '/read').child(_grpArr[i].id).once('child_added', function (userData) {
                    Alluser = 'userFound';
                    msgArr.push({ id: _grpArr[i].id });
                });
                if (Alluser !== 'userFound') {
                    Alluser = 'notFound';
                }
                // console.log('user is : ' + _grpArr[i].id + ' , find user is : ' + Alluser);
            }
            if (_grpArr.length === msgArr.length) {
                // console.log('husnain All Members have read this msg.');
                var _ref = firebase.database().ref("userMessages/" + grpid + '/' + snapshot.key);
                _ref.update({
                    isRead: true
                });
            }

            else {
                // console.log('husnain arrays not equal in length');
            }

        });


        /////////////////////////////////////////////////////////////////////////////////

        //////////////////// Method Two ///////////////////////////////
        /*
        var _grpArr = [];
        var groupUser = firebase.database().ref("Groups/" + grpid + "/users");
        groupUser.on('child_added', function (grpUser) {
            _grpArr.push({ id: grpUser.key });
        });

        var msgArr = [];
        var ref = firebase.database().ref("userMessages/" + grpid);
        ref.on("child_added", function (snapshot) {
            console.log('key is : ' + snapshot.key);
            var Alluser = 'notFound';
            ref.child(snapshot.key + '/read').on('child_added', function (userData) {
                Alluser = 'userFound';
                console.log('get user data : ' + userData.key);
                msgArr.push({ id: userData.key });
            });
            if (Alluser !== 'userFound') {
                Alluser = 'notFound';
            }
           // console.log('user result is , user is : ' + grpUser.key + ' , find user is : ' + Alluser);
        });
        var iLength = 0;
        for (var i = 0; i < _grpArr.length; i++) {
            var recordfind = msgArr.map(e => e.id).indexOf(_grpArr[i].id);
            if (recordfind > -1) {
                console.log('array record found : ' + msgArr[recordfind]);
            }
        }
        */
    }

    function UpdateUnreadCountForGroupUsers(grpId, _Users, shortmsg) {
        // debugger;
        for (var i = 0; i < _Users.length; i++) {
            var id = _Users[i].id;
            if (id !== SenderId) {
                var ref = firebase.database().ref("TeleUsers/" + id + '/Connections');
                ref.child(grpId).update({
                    lastOnline: firebase.database.ServerValue.TIMESTAMP,
                    lastMessage: shortmsg,
                    type: 'Public'
                }).then(function () {
                    return ref.child(grpId).once("value");
                }).then(function (snapshot) {
                    // debugger;
                    var data = snapshot.val();
                    var time = snapshot.val().lastOnline;
                    var unread = snapshot.val().unread;
                    if (unread)
                        unread += 1;
                    else
                        unread = 1;
                    //console.log('my local time is : ' + time);
                    var reff = firebase.database().ref("TeleUsers/" + id + '/Connections');
                    reff.child(grpId).update({
                        lastOnline: time * -1,
                        unread: unread
                    });

                });
            }
        }

    }
</script>
<script>
    var form;
    var _files;

    $("#file").click(function () {

        var inputTag = "<input type='file' name='Attachement' id='fileUpload'/>";
        var tagId = $(inputTag);

        tagId.change(function () {
            // console.log("selected file:" + $(this).val());
            var file = $(this).val();
            var arr = file.split('\\');
            //debugger;
            // console.log(arr[2]);
            _files = tagId[0].files;

            var formId = $(form);
            var _fdata = new FormData();
            for (var i = 0; i < _files.length; i++) {
                _fdata.append("Attachement", _files[i]);
            }
            _fdata.append("senderId", SenderId);
            var frmUrl = '/FirebaseChat/SaveAttachement';
            // console.log('button  click');

            var fileName = arr[2];

            var arrType = fileName.split('.');
            var lastIndex = arrType.length - 1;
            var fileType = arrType[lastIndex];

            var date = new Date();
            var _hour = date.getHours();
            var _min = date.getMinutes();
            var _month = date.getDay();
            var _sec = date.getSeconds();
            var _mil = date.getMilliseconds();
            var _day = date.getDay();
            var _year = date.getFullYear();

            var timeStamp = _year + '' + _month + '' + _day + '' + _hour + '' + _min + '' + _sec + '' + _mil;

            fileName = '/Content/ChatFile/' + SenderId + '-' + timeStamp + '-' + fileName;

            var id = SenderId + '-' + _receiverId;
            var _id = _receiverId + '-' + SenderId;

            _fdata.append("timeStamp", timeStamp);

            $.ajax({
                type: 'POST',
                url: frmUrl,
                data: _fdata,
                processData: false,
                contentType: false,
                success: function (e) {
                    // console.log('Success is :' + e);
                    if (isGroup)
                        _GroupMessages(_receiverId, fileName, fileType);
                    else
                        SendMessageNew(id, _id, fileName, fileType);
                },
                Error: function (e) {
                    // console.log('Error is :' + e);
                }
            });

        });
        tagId.trigger('click');
    });


</script>